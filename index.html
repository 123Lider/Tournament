<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pro Gaming App</title>

    <!-- Firebase SDK (v8) -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        /* --- GLOBAL STYLES --- */
        :root { --primary: #FF005C; --bg: #090910; --card: #14141F; --text: #fff; --green: #00F5D4; --cyan: #00D2D3; --yellow: #F1C40F; --red: #ff4757; }
        body { font-family: 'Poppins', sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 0; text-align: center; overflow-x: hidden; user-select: none; -webkit-tap-highlight-color: transparent; }
        
        .container { max-width: 480px; margin: 0 auto; min-height: 100vh; position: relative; padding-bottom: 90px;}
        .screen { display: none; padding: 20px; animation: fadeIn 0.4s ease; }
        .active { display: block; }
        @keyframes fadeIn { from {opacity:0; transform: translateY(10px);} to {opacity:1; transform: translateY(0);} }

        /* UI COMPONENTS */
        .card { background: var(--card); padding: 15px; border-radius: 16px; margin-bottom: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.05); }
        button { width: 100%; padding: 14px; margin: 10px 0; border: none; border-radius: 12px; background: var(--primary); color: #fff; font-weight: 700; cursor: pointer; transition: 0.3s; }
        .btn-green { background: linear-gradient(45deg, #00b894, #00cec9); color: #000; }
        .btn-red { background: linear-gradient(45deg, #ff7675, #d63031); }
        .btn-outline { background: transparent; border: 1px solid rgba(255,255,255,0.2); color:white; }
        input { width: 100%; padding: 15px; background: #0F0F16; border: 1px solid #333; color: white; border-radius: 10px; margin-bottom: 10px; box-sizing: border-box; }

        /* CUSTOM NOTIFICATION MODAL */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 10000; display: none; align-items: center; justify-content: center; backdrop-filter: blur(5px); animation: fadeIn 0.3s; }
        .modal-box { background: #191925; width: 85%; max-width: 320px; padding: 25px; border-radius: 20px; border: 1px solid rgba(255,255,255,0.1); text-align: center; box-shadow: 0 0 30px rgba(0,0,0,0.5); transform: scale(0.9); animation: popUp 0.3s forwards; }
        @keyframes popUp { to { transform: scale(1); } }
        .modal-btn { padding: 10px 25px; border-radius: 50px; border: none; font-weight: bold; cursor: pointer; font-size: 0.9rem; flex: 1; }
        .m-btn-yes { background: linear-gradient(45deg, #00b894, #00cec9); color: #000; }
        .m-btn-no { background: transparent; border: 1px solid #ff4757; color: #ff4757; }

        /* HEADER */
        header { background: rgba(20, 20, 31, 0.9); backdrop-filter: blur(10px); padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 50; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .balance-pill { background: linear-gradient(90deg, #11998e, #38ef7d); color: #fff; padding: 6px 15px; border-radius: 50px; font-weight: bold; cursor: pointer; }
        
        /* LOBBY GRID & RADAR */
        .lobby-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 15px; }
        .slot-card { background: #191925; border: 1px solid rgba(255,255,255,0.05); border-radius: 15px; padding: 20px 10px; position: relative; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: 0.2s; cursor: pointer; }
        .slot-icon { font-size: 1.8rem; margin-bottom: 8px; color: var(--cyan); }
        .slot-status { font-size: 0.7rem; padding: 3px 8px; border-radius: 4px; margin-top: 5px; }
        .st-wait { color: var(--yellow); background: rgba(241, 196, 15, 0.1); }
        .radar { width: 150px; height: 150px; background: rgba(0, 245, 212, 0.1); border: 2px solid var(--cyan); border-radius: 50%; position: relative; margin: 0 auto; overflow: hidden; box-shadow: 0 0 20px rgba(0, 245, 212, 0.3); }
        .scan { width: 100%; height: 100%; background: linear-gradient(180deg, rgba(0, 245, 212, 0.6), transparent); position: absolute; animation: radar-spin 2s linear infinite; transform-origin: bottom center; border-radius: 50%; clip-path: polygon(50% 50%, 0 0, 100% 0); opacity: 0.5; }
        @keyframes radar-spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

        /* LUDO BOARD CSS */
        #ludo-game { position: fixed; top: 0; left: 0; right: 0; bottom: 0; width: 100vw; height: 100vh; background-color: #2c3e50; z-index: 9999; padding: 0 !important; margin: 0 !important; display: flex; flex-direction: column; align-items: center; justify-content: center; overflow: hidden; visibility: hidden; opacity: 0; transition: 0.3s; }
        #ludo-game.active { visibility: visible; opacity: 1; }
        #game-area { width: 750px; height: 750px; background: white; box-shadow: 0 0 30px rgba(0,0,0,0.6); border: 5px solid #000; transform-origin: center; }
        .box_row { height: 300px; width: 750px; display: flex; }
        .middle_row { height: 150px; width: 750px; display: flex; }
        .box { height: 300px; width: 300px; position: relative; box-sizing: border-box; display: grid; grid-template-columns: repeat(2, 1fr); grid-template-rows: repeat(2, 1fr); place-items: center; padding: 40px; }
        .circle { height: 60px; width: 60px; border-radius: 50%; background: white; box-shadow: inset 3px 3px 8px rgba(0,0,0,0.3); position: relative; border: 1px solid rgba(0,0,0,0.1); }
        .v_lad { height: 300px; width: 150px; display: flex; flex-direction: column; }
        .v_lad_row { height: 50px; width: 150px; display: flex; }
        .h_lad { height: 150px; width: 300px; display: flex; flex-direction: column; }
        .h_lad_row { height: 50px; width: 300px; display: flex; }
        .cell { height: 50px; width: 50px; border: 1px solid #000; box-sizing: border-box; position: relative; display: flex; justify-content: center; align-items: center; }
        .border_red { border: 6px solid red; } .border_green { border: 6px solid #009432; } .border_blue { border: 6px solid #0652DD; } .border_yellow { border: 6px solid #f1c40f; }
        .bg-red { background: red; } .bg-green { background: #009432; } .bg-blue { background: #0652DD; } .bg-yellow { background: #f1c40f; }
        .safe-star { color: rgba(0,0,0,0.25); font-size: 36px; position: absolute; z-index: 1; pointer-events: none; }
        .ludo_home { height: 0; width: 0; border-left: 75px solid red; border-right: 75px solid #f1c40f; border-top: 75px solid #009432; border-bottom: 75px solid #0652DD; position: relative; display: flex; justify-content: center; align-items: center; }
        
        /* TOKEN STYLES (Stacking) */
        .token { 
            width: 32px; height: 42px; position: absolute; z-index: 10; 
            border-radius: 50% 50% 50% 50% / 60% 60% 35% 35%; 
            box-shadow: 2px 3px 5px rgba(0,0,0,0.6); 
            border: 2px solid rgba(255,255,255,0.8); 
            cursor: pointer; transition: all 0.2s ease; 
            top: 50%; left: 50%; transform: translate(-50%, -60%);
        }
        .token-green { background: radial-gradient(circle at 10px 10px, #4cd137, #006266); }
        .token-blue { background: radial-gradient(circle at 10px 10px, #00a8ff, #192a56); }
        .token.movable { animation: bounce 0.8s infinite alternate; box-shadow: 0 0 15px yellow; z-index: 100; border-color: yellow; }
        @keyframes bounce { from { transform: translate(-50%, -60%); } to { transform: translate(-50%, -75%); } }
        
        .token.grouped { width: 22px; height: 30px; z-index: 15; border-width: 1px; }
        .stack-0 { transform: translate(-100%, -100%); }
        .stack-1 { transform: translate(0%, -100%); }
        .stack-2 { transform: translate(-100%, -20%); }
        .stack-3 { transform: translate(0%, -20%); }
        .stack-center { transform: translate(-50%, -60%) scale(0.8); }

        .dice-panel { position: absolute; z-index: 200; background: rgba(255, 255, 255, 0.9); padding: 10px; border-radius: 15px; box-shadow: 0 10px 25px rgba(0,0,0,0.5); border: 3px solid #333; cursor: pointer; display: flex; flex-direction: column; align-items: center; width: 60px; left: 50%; transform: translateX(-50%); transition: 0.3s; opacity: 0.5; pointer-events: none;}
        
        /* YOU (Blue) Bottom, OPP (Green) Top */
        #panel-blue { bottom: -120px; border-color: #0652DD; } 
        #panel-green { top: -120px; border-color: #009432; } 

        .scene { width: 50px; height: 50px; perspective: 600px; }
        .cube { width: 100%; height: 100%; position: relative; transform-style: preserve-3d; transform: translateZ(-25px); transition: transform 0.6s cubic-bezier(0.2, 0.8, 0.2, 1); }
        .face { position: absolute; width: 50px; height: 50px; background: #fff; border: 1px solid #999; border-radius: 8px; display: grid; grid-template-columns: repeat(3, 1fr); grid-template-rows: repeat(3, 1fr); padding: 4px; }
        .dot { width: 10px; height: 10px; background: #000; border-radius: 50%; margin: auto; }
        .front { transform: rotateY(0deg) translateZ(25px); } .back { transform: rotateY(180deg) translateZ(25px); }
        .right { transform: rotateY(90deg) translateZ(25px); } .left { transform: rotateY(-90deg) translateZ(25px); }
        .top { transform: rotateX(90deg) translateZ(25px); } .bottom { transform: rotateX(-90deg) translateZ(25px); }
        .center { grid-area: 2 / 2; } .top-left { grid-area: 1 / 1; } .top-right { grid-area: 1 / 3; } .mid-left { grid-area: 2 / 1; } .mid-right { grid-area: 2 / 3; } .bottom-left { grid-area: 3 / 1; } .bottom-right { grid-area: 3 / 3; }

        .game-header { position: absolute; top: 10px; left: 10px; right: 10px; display: flex; justify-content: space-between; z-index: 300; pointer-events: none; width: 95%; margin: 0 auto; }
        .game-badge { background: rgba(0,0,0,0.8); color: white; padding: 5px 15px; border-radius: 20px; font-size: 0.8rem; pointer-events: all; }

        /* SETTINGS & WALLET */
        .wallet-fab { position: fixed; bottom: 30px; right: 30px; width: 60px; height: 60px; background: linear-gradient(135deg, var(--green), #009432); color: #fff; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 24px; box-shadow: 0 0 20px rgba(0, 245, 212, 0.4); z-index: 100; cursor: pointer; border: 2px solid #fff; transition: transform 0.2s; }
        .sidebar { position: fixed; top: 0; right: -100%; width: 100%; max-width: 400px; height: 100vh; background: #101018; z-index: 200; transition: 0.4s; padding: 0; box-sizing: border-box; overflow-y: auto; }
        .sidebar.open { right: 0; }
        .wallet-top { background: linear-gradient(180deg, #1F1F2E, #101018); padding: 30px 20px 20px; text-align: center; border-bottom: 1px solid #333; position: sticky; top: 0; z-index: 10; }
        .close-btn { position: absolute; top: 20px; left: 20px; font-size: 1.5rem; color: #aaa; cursor: pointer; }
        .tx-item { background: #181822; padding: 12px; margin-bottom: 8px; border-radius: 10px; display: flex; justify-content: space-between; align-items: center; border: 1px solid rgba(255,255,255,0.03); }
        .tx-in { background: rgba(0, 245, 212, 0.1); color: var(--green); } .tx-out { background: rgba(255, 71, 87, 0.1); color: var(--red); }
        
        .menu-btn { width: 40px; height: 40px; background: rgba(255,255,255,0.1); border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; margin-left: 10px; border: 1px solid rgba(255,255,255,0.1); }
        .settings-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 5000; display: none; align-items: center; justify-content: center; backdrop-filter: blur(5px); animation: fadeIn 0.3s; }
        .settings-card { background: #14141F; width: 85%; max-width: 350px; padding: 25px; border-radius: 20px; border: 1px solid rgba(255,255,255,0.1); text-align: center; position: relative; }
        .menu-list-item { background: rgba(255,255,255,0.05); padding: 15px; border-radius: 12px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; transition: 0.2s; border: 1px solid rgba(255,255,255,0.05); }
    </style>
</head>
<body>

<div class="container">

    <!-- 1. AUTH SCREEN -->
    <div id="auth-screen" class="screen active">
        <div class="card" style="margin-top: 15vh; padding: 30px;">
            <h1 style="color:var(--primary);">GAMING<span style="color:#fff">APP</span></h1>
            <div id="login-form">
                <input type="email" id="email" placeholder="Email Address">
                <input type="password" id="pass" placeholder="Password">
                <button onclick="login()">LOGIN</button>
            </div>
            <div id="signup-form" style="display:none;">
                <p style="color:#f1c40f; font-size:0.75rem; margin-bottom:10px;">* Location auto-detected *</p>
                <input type="text" id="su-name" placeholder="Full Name">
                <div style="text-align:right; margin-bottom:5px;">
                    <span onclick="detectLocation()" style="font-size:0.8rem; color:var(--cyan); cursor:pointer; border:1px solid var(--cyan); padding:2px 8px; border-radius:4px;"><i class="fas fa-map-marker-alt"></i> Auto Detect</span>
                </div>
                <input type="text" id="su-country" placeholder="Country" readonly style="background:#1a1a2e; color:#aaa;">
                <div style="display:flex; gap:10px;">
                    <input type="text" id="su-city" placeholder="City">
                    <input type="text" id="su-dist" placeholder="District">
                </div>
                <select id="su-pouro" style="width:100%; padding:15px; background:#0F0F16; color:white; border:1px solid #333; border-radius:10px; margin-bottom:10px; outline:none;">
                    <option value="" style="color:#aaa;">Select Area Type</option>
                    <option value="Paurashava">Paurashava</option>
                    <option value="Non-Paurashava">Non-Paurashava</option>
                </select>
                <input type="text" id="su-ward" placeholder="Ward No / Area">
                <input type="text" id="su-house" placeholder="House Name">
                <input type="email" id="su-email" placeholder="Gmail Address">
                <input type="password" id="su-pass" placeholder="Password (Min 6 chars)">
                <input type="password" id="su-conf-pass" placeholder="Confirm Password">
                <input type="text" id="promo-code" placeholder="Promo Code (Optional)">
                <button onclick="signup()" class="btn-green">CREATE ACCOUNT</button>
            </div>
            <p id="auth-toggle-msg" onclick="toggleAuthMode()" style="font-size:0.8rem; color:#aaa; cursor:pointer; margin-top:15px;">Don't have an account? <b style="color:var(--cyan)">Sign Up</b></p>
        </div>
    </div>

    <!-- 2. HOME SCREEN -->
    <div id="home-screen" class="screen">
        <header>
            <div style="text-align: left;"><small>Welcome,</small><br><b id="u-name">Player</b></div>
            <div style="display:flex; align-items:center;">
                <div class="balance-pill" onclick="toggleSidebar()"><i class="fas fa-wallet"></i> ‡ß≥ <span id="u-bal">0</span></div>
                <div class="menu-btn" onclick="openSettings()"><i class="fas fa-ellipsis-v"></i></div>
            </div>
        </header>

        <h3 style="margin: 25px 0 15px; text-align: left;">üî• Play & Win</h3>
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:15px;">
            <div class="card" onclick="showScreen('ludo-category-screen'); renderCategories();" style="cursor:pointer; text-align:center;">
                <i class="fas fa-dice" style="font-size: 3.5rem; color: #ff6b6b; margin-bottom: 10px;"></i>
                <h3>Ludo</h3>
                <p style="font-size:0.8rem; color:#aaa;">Auto Match</p>
            </div>
            <div class="card" onclick="openQuizLobby()" style="cursor:pointer; text-align:center;">
                <i class="fas fa-brain" style="font-size: 3.5rem; color: #feca57; margin-bottom: 10px;"></i>
                <h3>Quiz</h3>
                <p style="font-size:0.8rem; color:#aaa;">One Q per Area</p>
            </div>
        </div>
    </div>

    <!-- 3. LUDO CATEGORIES -->
    <div id="ludo-category-screen" class="screen">
        <button onclick="backToHome()" class="btn-outline"><i class="fas fa-arrow-left"></i> Home</button>
        <h2>üèÜ Select Match</h2>
        <div id="category-list"></div>
    </div>

    <!-- 4. MATCHMAKING SCREEN -->
    <div id="matchmaking-screen" class="screen" style="text-align:center; padding-top:100px;">
        <div class="radar"><div class="scan"></div></div>
        <h2 style="margin-top:20px; color:var(--cyan);">Searching Opponent...</h2>
        <p id="search-status" style="color:#aaa;">Analyzing players...</p>
        <div id="search-timer" style="display:none;">10</div>
        <button onclick="cancelSearch()" class="btn-red" style="width:auto; padding:10px 30px; margin-top:30px;">CANCEL</button>
    </div>

    <!-- 5. QUIZ LOBBY -->
    <div id="quiz-lobby-screen" class="screen">
        <button onclick="backToHome()" class="btn-outline"><i class="fas fa-arrow-left"></i> Home</button>
        <div class="card" style="background:rgba(255,193,7,0.1); border:1px solid var(--yellow); color:var(--yellow); text-align:left; margin-top:10px;">
            <b>üì¢ NOTICE:</b> <span id="quiz-notice-text">Loading...</span>
        </div>
        <h3>üß† Select Quiz Match</h3>
        <div id="quiz-list-container" class="lobby-grid"></div>
    </div>

    <!-- 6. QUIZ GAME -->
    <div id="quiz-game-screen" class="screen">
        <div class="card">
            <div style="display:flex; justify-content:space-between; color:#aaa;"><span id="q-count">1/10</span><span style="color:var(--green)" id="q-win">Win: 0‡ß≥</span></div>
            <div id="q-timer" style="font-size:2rem; font-weight:bold; color:var(--yellow); margin:10px 0;">15s</div>
            <h3 id="q-text" style="min-height:60px;">Loading...</h3>
            <div id="opt-container" style="display:grid; grid-template-columns:1fr 1fr; gap:10px;"></div>
        </div>
    </div>
</div>

<!-- 7. LUDO GAME BOARD -->
<div id="ludo-game" class="screen">
    <div class="game-header">
        <div class="game-badge" style="background:var(--primary);">Prize: <span id="g-prize">0</span>‡ß≥</div>
        <div class="game-badge" style="background:#333;" onclick="alert('Cannot quit active match!')"><i class="fas fa-bars"></i></div>
    </div>

    <div id="game-area">
        <!-- P2 Dice (Green/Top) - OPPONENT -->
        <div class="dice-panel" id="panel-green" onclick="rollDiceRequest('green')">
            <div class="scene"><div class="cube" id="cube-green"><div class="face front"><div class="dot center"></div></div><div class="face back"><div class="dot top-left"></div><div class="dot bottom-right"></div><div class="dot top-right"></div><div class="dot bottom-left"></div><div class="dot mid-left"></div><div class="dot mid-right"></div></div><div class="face right"><div class="dot top-left"></div><div class="dot center"></div><div class="dot bottom-right"></div></div><div class="face left"><div class="dot top-left"></div><div class="dot bottom-right"></div><div class="dot top-right"></div><div class="dot bottom-left"></div></div><div class="face top"><div class="dot top-left"></div><div class="dot bottom-right"></div></div><div class="face bottom"><div class="dot top-left"></div><div class="dot bottom-right"></div><div class="dot center"></div><div class="dot top-right"></div><div class="dot bottom-left"></div></div></div></div>
            <div style="margin-top:5px; color:#009432; font-weight:bold; font-size:10px;">OPP (P2)</div>
        </div>
        
        <!-- P1 Dice (Blue/Bottom) - YOU -->
        <div class="dice-panel" id="panel-blue" onclick="rollDiceRequest('blue')">
            <div class="scene"><div class="cube" id="cube-blue"><div class="face front"><div class="dot center"></div></div><div class="face back"><div class="dot top-left"></div><div class="dot bottom-right"></div><div class="dot top-right"></div><div class="dot bottom-left"></div><div class="dot mid-left"></div><div class="dot mid-right"></div></div><div class="face right"><div class="dot top-left"></div><div class="dot center"></div><div class="dot bottom-right"></div></div><div class="face left"><div class="dot top-left"></div><div class="dot bottom-right"></div><div class="dot top-right"></div><div class="dot bottom-left"></div></div><div class="face top"><div class="dot top-left"></div><div class="dot bottom-right"></div></div><div class="face bottom"><div class="dot top-left"></div><div class="dot bottom-right"></div><div class="dot center"></div><div class="dot top-right"></div><div class="dot bottom-left"></div></div></div></div>
            <div style="margin-top:5px; color:#0652DD; font-weight:bold; font-size:10px;">YOU (P1)</div>
        </div>

        <div class="box_row">
            <div class="box" style="border: 50px solid red;"><div class="circle border_red"></div><div class="circle border_red"></div><div class="circle border_red"></div><div class="circle border_red"></div></div>
            <div class="v_lad">
                <div class="v_lad_row"><div class="cell" id="cell-10"></div><div class="cell" id="cell-11"></div><div class="cell" id="cell-12"></div></div>
                <div class="v_lad_row"><div class="cell" id="cell-9"></div><div class="cell bg-green" id="ghome-1"></div><div class="cell bg-green" id="cell-13"><span class="safe-star">&#9733;</span></div></div>
                <div class="v_lad_row"><div class="cell" id="cell-8"><span class="safe-star">&#9733;</span></div><div class="cell bg-green" id="ghome-2"></div><div class="cell" id="cell-14"></div></div>
                <div class="v_lad_row"><div class="cell" id="cell-7"></div><div class="cell bg-green" id="ghome-3"></div><div class="cell" id="cell-15"></div></div>
                <div class="v_lad_row"><div class="cell" id="cell-6"></div><div class="cell bg-green" id="ghome-4"></div><div class="cell" id="cell-16"></div></div>
                <div class="v_lad_row"><div class="cell" id="cell-5"></div><div class="cell bg-green" id="ghome-5"></div><div class="cell" id="cell-17"></div></div>
            </div>
            <div class="box" style="border: 50px solid #009432;"><div class="circle border_green" id="green-jail-0"></div><div class="circle border_green" id="green-jail-1"></div><div class="circle border_green" id="green-jail-2"></div><div class="circle border_green" id="green-jail-3"></div></div>
        </div>
        <div class="middle_row">
            <div class="h_lad">
                <div class="h_lad_row"><div class="cell" id="cell-51"></div><div class="cell bg-red" id="cell-0"><span class="safe-star">&#9733;</span></div><div class="cell" id="cell-1"></div><div class="cell" id="cell-2"></div><div class="cell" id="cell-3"></div><div class="cell" id="cell-4"></div></div>
                <div class="h_lad_row"><div class="cell" id="cell-50"></div><div class="cell bg-red"></div><div class="cell bg-red"></div><div class="cell bg-red"></div><div class="cell bg-red"></div><div class="cell bg-red"></div></div>
                <div class="h_lad_row"><div class="cell" id="cell-49"></div><div class="cell" id="cell-48"></div><div class="cell bg-red" id="cell-47"><span class="safe-star">&#9733;</span></div><div class="cell" id="cell-46"></div><div class="cell" id="cell-45"></div><div class="cell" id="cell-44"></div></div>
            </div>
            <div class="ludo_home" id="winning-home"></div>
            <div class="h_lad">
                <div class="h_lad_row"><div class="cell" id="cell-18"></div><div class="cell" id="cell-19"></div><div class="cell" id="cell-20"></div><div class="cell bg-yellow" id="cell-21"><span class="safe-star">&#9733;</span></div><div class="cell" id="cell-22"></div><div class="cell" id="cell-23"></div></div>
                <div class="h_lad_row"><div class="cell bg-yellow"></div><div class="cell bg-yellow"></div><div class="cell bg-yellow"></div><div class="cell bg-yellow"></div><div class="cell bg-yellow"></div><div class="cell" id="cell-24"></div></div>
                <div class="h_lad_row"><div class="cell" id="cell-30"></div><div class="cell" id="cell-29"></div><div class="cell" id="cell-28"></div><div class="cell" id="cell-27"></div><div class="cell bg-yellow" id="cell-26"><span class="safe-star">&#9733;</span></div><div class="cell" id="cell-25"></div></div>
            </div>
        </div>
        <div class="box_row">
            <div class="box" style="border: 50px solid #0652DD;"><div class="circle border_blue" id="blue-jail-0"></div><div class="circle border_blue" id="blue-jail-1"></div><div class="circle border_blue" id="blue-jail-2"></div><div class="circle border_blue" id="blue-jail-3"></div></div>
            <div class="v_lad">
                <div class="v_lad_row"><div class="cell" id="cell-43"></div><div class="cell bg-blue" id="bhome-5"></div><div class="cell" id="cell-31"></div></div>
                <div class="v_lad_row"><div class="cell" id="cell-42"></div><div class="cell bg-blue" id="bhome-4"></div><div class="cell" id="cell-32"></div></div>
                <div class="v_lad_row"><div class="cell" id="cell-41"></div><div class="cell bg-blue" id="bhome-3"></div><div class="cell" id="cell-33"></div></div>
                <div class="v_lad_row"><div class="cell" id="cell-40"></div><div class="cell bg-blue" id="bhome-2"></div><div class="cell bg-blue" id="cell-34"><span class="safe-star">&#9733;</span></div></div>
                <div class="v_lad_row"><div class="cell bg-blue" id="cell-39"><span class="safe-star">&#9733;</span></div><div class="cell bg-blue" id="bhome-1"></div><div class="cell" id="cell-35"></div></div>
                <div class="v_lad_row"><div class="cell" id="cell-38"></div><div class="cell" id="cell-37"></div><div class="cell" id="cell-36"></div></div>
            </div>
            <div class="box" style="border: 50px solid #f1c40f;"><div class="circle border_yellow"></div><div class="circle border_yellow"></div><div class="circle border_yellow"></div><div class="circle border_yellow"></div></div>
        </div>
    </div>
</div>

<!-- SIDEBAR WALLET -->
<div id="main-wallet-btn" class="wallet-fab" onclick="toggleSidebar()" style="display: none;"><i class="fas fa-wallet"></i></div>
<div id="wallet-sidebar" class="sidebar">
    <div class="wallet-top">
        <div class="close-btn" onclick="toggleSidebar()"><i class="fas fa-times"></i></div>
        <small style="color:#aaa;">AVAILABLE BALANCE</small><div class="wallet-bal">‡ß≥ <span id="side-bal">0</span></div>
        <div class="wallet-tabs"><button class="tab-btn tab-active" id="btn-dep" onclick="switchTab('deposit')">Deposit</button><button class="tab-btn" id="btn-with" onclick="switchTab('withdraw')">Withdraw</button></div>
    </div>
    <div class="wallet-content">
        <div id="dep-section">
            <div class="card" style="margin-bottom:15px; text-align:left;"><small>Send Money To:</small><div style="font-size:1.1rem; font-weight:bold; color:var(--cyan); display:flex; justify-content:space-between;"><span id="admin-bkash">Loading...</span><i class="fas fa-copy" onclick="copyNumber()"></i></div></div>
            <input type="number" id="dep-amount" placeholder="Amount (Min 200)">
            <input type="text" id="dep-trx" placeholder="Transaction ID">
            <button class="btn-green" onclick="submitDeposit()" style="margin-top:10px;">Submit Request</button>
        </div>
        <div id="with-section" style="display:none;">
            <input type="number" id="with-amount" placeholder="Amount (Min 500)"><input type="text" id="with-num" placeholder="Your Number"><input type="password" id="with-pass" placeholder="Account Password"><button class="btn-red" onclick="submitWithdraw()" style="margin-top:10px;">Request Withdraw</button>
        </div>
    </div>
</div>

<!-- SETTINGS MODAL -->
<div id="settings-modal" class="settings-modal">
    <div class="settings-card">
        <div class="close-settings" onclick="closeSettings()">&times;</div>
        <h3>‚öôÔ∏è Settings</h3>
        <p style="color:#aaa; font-size:0.9rem;">User ID: <span id="modal-promo">...</span></p>
        <div class="menu-list-item" onclick="openPassModal()"><div><i class="fas fa-lock"></i> Change Password</div></div>
        <div class="menu-list-item" onclick="auth.signOut(); closeSettings();" style="border-color:var(--red);">
            <div style="color:var(--red);"><i class="fas fa-sign-out-alt"></i> Logout</div>
        </div>
    </div>
</div>

<!-- PASSWORD MODAL -->
<div id="pass-modal" class="settings-modal">
    <div class="settings-card">
        <h3>üîí Security Check</h3>
        <input type="password" id="old-pass" placeholder="Old Password">
        <input type="password" id="new-pass" placeholder="New Password">
        <input type="password" id="conf-pass" placeholder="Confirm Password">
        <button class="btn-green" onclick="updatePasswordSecure()">Change</button>
        <button class="btn-outline" onclick="closePassModal()">Cancel</button>
    </div>
</div>

<!-- CUSTOM NOTIFICATION MODAL -->
<div id="custom-modal" class="modal-overlay">
    <div class="modal-box">
        <h3 id="modal-title" style="margin-top:0; color:var(--primary);">Notification</h3>
        <p id="modal-msg" style="color:#ddd; font-size:1rem; margin:15px 0;">Message here</p>
        <div id="modal-actions" style="display:flex; gap:10px; justify-content:center;"></div>
    </div>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyAVqB7Tt7KqsP8hib48roEnsnCuLjssGHg",
        authDomain: "chat-calle.firebaseapp.com",
        projectId: "chat-calle",
        storageBucket: "chat-calle.appspot.com",
        messagingSenderId: "159197641650",
        appId: "1:159197641650:web:a4cfa73d57f4055adbc2ab"
    };
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    let user = null, balance = 0, currentMatch = null;
    let quizData=[], currentQ=0, quizTimer=null, quizEarned=0, currentReward=0;
    let isLoginMode = true;
    
    // --- SOUND SETUP ---
    const soundDice = new Audio('https://www.soundjay.com/misc/sounds/dice-throw-1.mp3'); 
    const soundMove = new Audio('https://www.soundjay.com/button/sounds/button-16.mp3');

    // --- CUSTOM NOTIFICATIONS ---
    window.alert = function(message) { showCustomModal(message, "alert"); };
    function showCustomModal(msg, type, yesCallback) {
        const modal = document.getElementById('custom-modal');
        const msgEl = document.getElementById('modal-msg');
        const actionDiv = document.getElementById('modal-actions');
        msgEl.innerText = msg; actionDiv.innerHTML = ""; 
        if(type === 'alert') {
            actionDiv.innerHTML = `<button class="modal-btn m-btn-yes" onclick="closeCustomModal()">OK</button>`;
        } else if(type === 'confirm') {
            const yesBtn = document.createElement('button'); yesBtn.className = "modal-btn m-btn-yes"; yesBtn.innerText = "YES"; yesBtn.onclick = () => { closeCustomModal(); if(yesCallback) yesCallback(); };
            const noBtn = document.createElement('button'); noBtn.className = "modal-btn m-btn-no"; noBtn.innerText = "NO"; noBtn.onclick = closeCustomModal;
            actionDiv.appendChild(noBtn); actionDiv.appendChild(yesBtn);
        }
        modal.style.display = 'flex';
    }
    function closeCustomModal() { document.getElementById('custom-modal').style.display = 'none'; }

    // --- GAME CONSTANTS ---
    const tournaments = [{id:'t1', fee:50, win:90, name:'Practice Match'}, {id:'t2', fee:100, win:190, name:'Silver Cup'}, {id:'t3', fee:200, win:370, name:'Gold Cup'}];
    const pathMap = { 'green': [], 'blue': [] };
    const safeZone = ['cell-0', 'cell-8', 'cell-13', 'cell-21', 'cell-26', 'cell-34', 'cell-39', 'cell-47'];
    
    function createPaths() {
        for (let i = 13; i <= 51; i++) pathMap.green.push(`cell-${i}`);
        for (let i = 0; i <= 11; i++) pathMap.green.push(`cell-${i}`);
        for (let i = 1; i <= 5; i++) pathMap.green.push(`ghome-${i}`);
        pathMap.green.push('winning-home');
        for (let i = 39; i <= 51; i++) pathMap.blue.push(`cell-${i}`);
        for (let i = 0; i <= 37; i++) pathMap.blue.push(`cell-${i}`);
        for (let i = 1; i <= 5; i++) pathMap.blue.push(`bhome-${i}`);
        pathMap.blue.push('winning-home');
    }
    createPaths();
    
    let diceAngle = { 'green': {x:0, y:0}, 'blue': {x:0, y:0} };

    // --- AUTH & COMMON LOGIC ---
    auth.onAuthStateChanged(u => {
        if(u) {
            user = u;
            showScreen('home-screen');
            document.getElementById('main-wallet-btn').style.display = 'flex';
            loadUserData();
        } else {
            showScreen('auth-screen');
            document.getElementById('main-wallet-btn').style.display = 'none';
        }
    });

    function loadUserData() {
        db.collection('users').doc(user.uid).onSnapshot(doc => {
            if(doc.exists) {
                const d = doc.data();
                balance = d.balance || 0;
                document.getElementById('u-bal').innerText = balance;
                document.getElementById('side-bal').innerText = balance;
                document.getElementById('u-name').innerText = d.name;
                document.getElementById('modal-promo').innerText = user.uid.substring(0,8);
            }
        });
        db.collection('config').doc('payment').onSnapshot(d => { if(d.exists) { document.getElementById('admin-bkash').innerText = d.data().bkashNumber; } });
    }

    function toggleAuthMode() {
        isLoginMode = !isLoginMode;
        document.getElementById('login-form').style.display = isLoginMode ? 'block' : 'none';
        document.getElementById('signup-form').style.display = isLoginMode ? 'none' : 'block';
        document.getElementById('auth-toggle-msg').innerHTML = isLoginMode ? "Don't have an account? <b style='color:var(--cyan)'>Sign Up</b>" : "Already have an account? <b style='color:var(--cyan)'>Login</b>";
    }

    function login() { auth.signInWithEmailAndPassword(document.getElementById('email').value, document.getElementById('pass').value).catch(e=>alert(e.message)); }
    
    function signup() {
        const name = document.getElementById('su-name').value;
        const country = document.getElementById('su-country').value;
        const city = document.getElementById('su-city').value;
        const dist = document.getElementById('su-dist').value;
        const ward = document.getElementById('su-ward').value;
        const house = document.getElementById('su-house').value;
        const email = document.getElementById('su-email').value;
        const pass = document.getElementById('su-pass').value;

        if(pass.length < 6) return alert("Password min 6 chars");
        
        const uniqueAddressId = `${country}_${dist}_${city}_${ward}_${house}`.replace(/\s+/g, '_').toLowerCase();

        auth.createUserWithEmailAndPassword(email, pass).then(cred => {
            db.collection('users').doc(cred.user.uid).set({ 
                name, email, balance: 0, 
                country, city, district: dist, ward, house,
                addressId: uniqueAddressId,
                createdAt: Date.now() 
            });
            alert("Account Created! Please Login.");
            auth.signOut();
            toggleAuthMode();
        }).catch(e => alert(e.message));
    }
    
    function detectLocation() {
        fetch('https://ipapi.co/json/').then(res => res.json()).then(data => {
            document.getElementById('su-country').value = data.country_name || "Bangladesh";
            document.getElementById('su-city').value = data.city || "";
        }).catch(err => console.log(err));
    }
    setTimeout(detectLocation, 2000);

    // --- QUIZ LOGIC ---
    function openQuizLobby() {
        showScreen('quiz-lobby-screen');
        db.collection('config').doc('quiz_notice').onSnapshot(d => {
            document.getElementById('quiz-notice-text').innerText = d.exists ? d.data().text : "Welcome!";
        });
        const container = document.getElementById('quiz-list-container');
        container.innerHTML = "<p>Loading...</p>";
        db.collection('quiz_categories').onSnapshot(snap => {
            container.innerHTML = "";
            if(snap.empty) { container.innerHTML = "<p>No active matches.</p>"; return; }
            snap.forEach(doc => {
                const q = doc.data();
                container.innerHTML += `
                <div class="slot-card" onclick="startQuiz('${doc.id}', ${q.fee}, ${q.win}, ${q.total})">
                    <i class="fas ${q.icon || 'fa-brain'} slot-icon"></i>
                    <h4>${q.name}</h4>
                    <div class="slot-status st-wait">Entry: ${q.fee}‡ß≥ (Win ${q.win}/Q)</div>
                    <small style="color:#aaa;">${q.total} Questions</small>
                </div>`;
            });
        });
    }

    async function startQuiz(catId, fee, reward, totalQ) {
        if(balance < fee) return alert("Insufficient Balance!");
        showCustomModal(`Start Quiz for ${fee} TK?`, 'confirm', async () => {
            const uDoc = await db.collection('users').doc(user.uid).get();
            const myAddressId = uDoc.data().addressId;
            if(!myAddressId) return alert("Update profile address!");

            const qSnap = await db.collection('questions').get();
            let available = [];
            qSnap.forEach(doc => {
                const q = doc.data();
                const blockedAddresses = q.usedInAddresses || [];
                if(!blockedAddresses.includes(myAddressId)) { available.push({id: doc.id, ...q}); }
            });

            if(available.length < totalQ) return alert("Not enough new questions for your Area!");
            await db.collection('users').doc(user.uid).update({balance: firebase.firestore.FieldValue.increment(-fee)});
            
            available.sort(() => 0.5 - Math.random());
            quizData = available.slice(0, totalQ);
            currentQ = 0; quizEarned = 0; currentReward = reward;
            
            showScreen('quiz-game-screen');
            loadQuestion();
        });
    }

    function submitAns(qId, selectedIndex, correctIndex) {
        clearInterval(quizTimer);
        const isCorrect = (selectedIndex === correctIndex);
        if(isCorrect) { quizEarned += currentReward; alert("Correct! ‚úÖ"); } 
        else { alert("Wrong! ‚ùå"); }
        
        db.collection('users').doc(user.uid).get().then(uDoc => {
            const myAddressId = uDoc.data().addressId;
            db.collection('questions').doc(qId).update({
                usedInAddresses: firebase.firestore.FieldValue.arrayUnion(myAddressId)
            });
        });
        currentQ++; loadQuestion();
    }

    function loadQuestion() {
        if(currentQ >= quizData.length) {
            alert(`Game Over! You Won: ${quizEarned} TK`);
            db.collection('users').doc(user.uid).update({balance: firebase.firestore.FieldValue.increment(quizEarned)});
            backToHome(); return;
        }
        const q = quizData[currentQ];
        document.getElementById('q-text').innerText = q.q;
        document.getElementById('q-count').innerText = `${currentQ+1}/${quizData.length}`;
        document.getElementById('q-win').innerText = `Won: ${quizEarned}‡ß≥`;
        
        let html = "";
        q.o.forEach((opt, i) => {
            html += `<button class="btn-outline" style="width:100%; text-align:left; margin-bottom:10px;" onclick="submitAns('${q.id}', ${i}, ${q.a})">${opt}</button>`;
        });
        document.getElementById('opt-container').innerHTML = html;

        let t = 15;
        document.getElementById('q-timer').innerText = t+"s";
        clearInterval(quizTimer);
        quizTimer = setInterval(() => {
            t--; document.getElementById('q-timer').innerText = t+"s";
            if(t<=0) { clearInterval(quizTimer); alert("Time Up!"); backToHome(); }
        }, 1000);
    }

    // --- ROBUST MATCHMAKING (TRANSACTION BASED) ---
    let searchInterval = null;
    let searchingMatchId = null;

    function renderCategories() { 
        const div = document.getElementById('category-list'); 
        div.innerHTML = ""; 
        tournaments.forEach(t => { 
            div.innerHTML += `
            <div class="card" style="display:flex; justify-content:space-between; align-items:center;" onclick="startMatchmaking('${t.id}', ${t.fee}, ${t.win})">
                <div style="text-align:left;"><h4 style="margin:0; color:#fff;">${t.name}</h4><span style="font-size:0.8rem; color:#aaa;">Prize: <b style="color:var(--green)">${t.win}‡ß≥</b></span></div>
                <button class="btn-outline" style="width:auto; border-color:var(--primary); color:var(--primary)">PLAY ${t.fee}‡ß≥</button>
            </div>`; 
        }); 
    }

    async function startMatchmaking(tid, fee, win) {
        if(balance < fee) return alert("Insufficient Balance!");
        
        showCustomModal(`Start Match for ${fee} TK?`, 'confirm', async () => {
            await db.collection('users').doc(user.uid).update({balance: firebase.firestore.FieldValue.increment(-fee)});
            showScreen('matchmaking-screen');
            let timeLeft = 10;
            const timerEl = document.getElementById('search-timer');
            timerEl.innerText = timeLeft;
            
            try {
                await findOrCreateMatch(tid, fee, win);
                searchInterval = setInterval(() => {
                    timeLeft--; timerEl.innerText = timeLeft;
                    if(timeLeft <= 0) { clearInterval(searchInterval); assignBot(); }
                }, 1000);
            } catch(e) { alert("Error: " + e.message); backToHome(); }
        });
    }

    async function findOrCreateMatch(tid, fee, win) {
        const matchesRef = db.collection('matches');
        
        await db.runTransaction(async (transaction) => {
            // Find an open match
            const snapshot = await matchesRef.where('type', '==', tid).where('status', '==', 'waiting').limit(1).get();
            
            if (!snapshot.empty) {
                const doc = snapshot.docs[0];
                const matchData = doc.data();
                
                // If I am P1, I must wait
                if(matchData.p1 === user.uid) { 
                    searchingMatchId = doc.id;
                    return; 
                }

                // If I can join
                transaction.update(matchesRef.doc(doc.id), {
                    p2: user.uid, p2Name: user.email.split('@')[0],
                    status: 'active', gameStartTime: Date.now(),
                    p2Ready: true, p1Ready: true
                });
                searchingMatchId = doc.id;
                
            } else {
                // Create new match
                const newDocRef = matchesRef.doc();
                transaction.set(newDocRef, {
                    type: tid, fee: fee, prize: win,
                    p1: user.uid, p1Name: user.email.split('@')[0],
                    startTime: Date.now(), status: 'waiting', turn: 'blue', 
                    p1Pos:[-1,-1,-1,-1], p2Pos:[-1,-1,-1,-1],
                    lastMove: Date.now(), rollCount: 0, p1Ready: true
                });
                searchingMatchId = newDocRef.id;
            }
        });

        // After transaction, either start game or wait
        if(searchingMatchId) {
             // Listener will handle entering game
             waitForOpponent(searchingMatchId);
        }
    }

    function waitForOpponent(mid) {
        const unsub = db.collection('matches').doc(mid).onSnapshot(doc => {
            if(!doc.exists) return;
            const data = doc.data();
            if(data.p2 && data.status === 'active') { 
                clearInterval(searchInterval); 
                enterGame(mid); 
                unsub(); 
            }
        });
    }

    async function assignBot() {
        if(!searchingMatchId) return;
        
        try {
            await db.runTransaction(async (transaction) => {
                const docRef = db.collection('matches').doc(searchingMatchId);
                const doc = await transaction.get(docRef);
                if(!doc.exists) return;
                
                const data = doc.data();
                if(!data.p2) { // Only add bot if P2 is still empty
                    const randomNames = ["Rahim_Pro", "King_Ludo", "Sultana_BD", "Tiger_75"];
                    const botName = randomNames[Math.floor(Math.random() * randomNames.length)];
                    transaction.update(docRef, {
                        p2: 'bot_system_ai', p2Name: botName,
                        status: 'active', gameStartTime: Date.now(), p2Ready: true
                    });
                }
            });
            // Snapshot listener will trigger enterGame
        } catch(e) { console.log(e); }
    }

    function cancelSearch() {
        clearInterval(searchInterval);
        if(searchingMatchId) db.collection('matches').doc(searchingMatchId).delete();
        backToHome();
    }

    // --- LUDO GAME ENGINE ---
    let isRolling = false; // Lock for player
    let botProcessing = false; // Lock for bot

    function enterGame(mid) {
        clearInterval(searchInterval);
        currentMatch = mid; showScreen('ludo-game'); resizeBoard();
        
        db.collection('matches').doc(mid).onSnapshot(d => {
            if(!d.exists) { 
                if(document.getElementById('ludo-game').classList.contains('active')) { alert("Match Ended!"); backToHome(); }
                return; 
            }
            const g = d.data();
            document.getElementById('g-prize').innerText = g.prize;
            renderTokens(g.p1Pos, g.p2Pos);
            
            // Re-enable player roll if turn changed to blue
            if(g.turn === 'blue' && !g.diceRolled) isRolling = false;

            const amP1 = (user.uid === g.p1);
            if(amP1) {
                document.getElementById('panel-blue').style.pointerEvents = 'all';
                document.getElementById('panel-green').style.pointerEvents = 'none';
                document.getElementById('panel-green').style.opacity = '0.3';
                document.getElementById('panel-blue').style.opacity = g.turn === 'blue' ? '1' : '0.5';
            } else {
                document.getElementById('panel-blue').style.pointerEvents = 'none';
                document.getElementById('panel-green').style.pointerEvents = 'all';
                document.getElementById('panel-blue').style.opacity = '0.3';
                document.getElementById('panel-green').style.opacity = g.turn === 'green' ? '1' : '0.5';
            }

            // BOT LOGIC
            if(g.p2 === 'bot_system_ai' && g.turn === 'green' && !g.diceRolled && !botProcessing) {
                botProcessing = true; setTimeout(() => playBotTurn(mid), 1000);
            }

            if(g.rollCount > (window.lastRollCount || 0)) {
                soundDice.play().catch(e=>{}); animateDice(g.turn, g.lastRoll);
                window.lastRollCount = g.rollCount;
            }
            
            if(g.winner) {
                if(g.winner === user.uid) { alert("üéâ YOU WON!"); db.collection('users').doc(user.uid).update({balance: firebase.firestore.FieldValue.increment(g.prize)}); } 
                else if(g.winner === 'bot_system_ai') { alert("ü§ñ Bot Won!"); } 
                else { alert("üòû YOU LOST!"); }
                db.collection('matches').doc(mid).delete(); backToHome();
            }
        });
    }

    function rollDiceRequest(color) {
        if(!currentMatch || isRolling) return; 
        db.collection('matches').doc(currentMatch).get().then(doc => {
            const g = doc.data();
            const amP1 = (user.uid === g.p1);
            if(amP1 && color !== 'blue') return;
            if(!amP1 && color !== 'green') return;
            if(g.turn !== color || g.diceRolled) return;

            isRolling = true; 
            const r = Math.floor(Math.random() * 6) + 1;
            db.collection('matches').doc(currentMatch).update({ lastRoll: r, rollCount: firebase.firestore.FieldValue.increment(1), diceRolled: true });
        });
    }

    function playBotTurn(mid) {
        const r = Math.floor(Math.random() * 6) + 1;
        db.collection('matches').doc(mid).update({ lastRoll: r, rollCount: firebase.firestore.FieldValue.increment(1), diceRolled: true });
        setTimeout(() => { animateDice('green', r); setTimeout(() => moveBotToken(mid, r), 1000); }, 500);
    }

    function animateDice(color, num) {
        let x=0, y=0;
        if(num==1){x=0;y=0;} else if(num==6){x=0;y=180;} else if(num==2){x=-90;y=0;}
        else if(num==5){x=90;y=0;} else if(num==3){x=0;y=-90;} else if(num==4){x=0;y=90;}
        let nx = diceAngle[color].x - (diceAngle[color].x%360) + 360*2 + x;
        let ny = diceAngle[color].y - (diceAngle[color].y%360) + 360*2 + y;
        diceAngle[color] = {x:nx, y:ny};
        document.getElementById(`cube-${color}`).style.transform = `translateZ(-25px) rotateX(${nx}deg) rotateY(${ny}deg)`;
        
        db.collection('matches').doc(currentMatch).get().then(doc => {
            const g = doc.data();
            const amP1 = (user.uid === g.p1);
            if((amP1 && color === 'blue') || (!amP1 && color === 'green')) { setTimeout(() => highlightMovableTokens(color, num), 600); }
        });
    }

    function highlightMovableTokens(color, roll) {
        db.collection('matches').doc(currentMatch).get().then(doc => {
            const g = doc.data();
            const posArray = color === 'blue' ? g.p1Pos : g.p2Pos;
            let canMove = false;
            posArray.forEach((pos, i) => {
                const el = document.getElementById(`t-${color}-${i}`);
                if(el && ((pos===-1 && roll===6) || (pos!==-1 && pos+roll<=56))) { el.classList.add('movable'); canMove = true; }
            });
            if(!canMove) {
                setTimeout(() => {
                    db.collection('matches').doc(currentMatch).update({ turn: color === 'blue' ? 'green' : 'blue', diceRolled: false });
                    isRolling = false; 
                }, 1000);
            }
        });
    }

    function handleTokenClick(color, idx, currentPos) {
        const el = document.getElementById(`t-${color}-${idx}`);
        if(!el || !el.classList.contains('movable') || isRolling) return;
        soundMove.play().catch(e=>{}); el.style.opacity = '0.5'; isRolling = true;

        db.runTransaction(async t => {
            const ref = db.collection('matches').doc(currentMatch);
            const doc = await t.get(ref);
            const g = doc.data(); const roll = g.lastRoll;
            let newPos = (currentPos === -1) ? 0 : currentPos + roll;
            let p1Pos = g.p1Pos, p2Pos = g.p2Pos;
            if(color==='blue') p1Pos[idx] = newPos; else p2Pos[idx] = newPos;

            const myCellId = pathMap[color][newPos];
            const isSafe = safeZone.includes(myCellId);
            if(!isSafe && newPos < 56) {
                const oppColor = color==='blue'?'green':'blue';
                const oppArr = color==='blue'?p2Pos:p1Pos;
                oppArr.forEach((opos, oi) => {
                    if(opos!==-1 && opos<56 && pathMap[oppColor][opos] === myCellId) {
                        if(color==='blue') p2Pos[oi] = -1; else p1Pos[oi] = -1;
                    }
                });
            }
            let winner = null;
            if(color==='blue' && p1Pos.every(p=>p===56)) winner = g.p1;
            if(color==='green' && p2Pos.every(p=>p===56)) winner = g.p2;

            t.update(ref, {
                p1Pos, p2Pos, turn: (roll===6 || newPos===56) ? color : (color==='blue'?'green':'blue'),
                diceRolled: false, winner: winner || firebase.firestore.FieldValue.delete()
            });
        }).then(() => { isRolling = false; }).catch(e => { isRolling = false; el.style.opacity = '1'; });
    }

    // --- ROBUST BOT MOVE LOGIC ---
    function moveBotToken(mid, roll) {
        db.runTransaction(async t => {
            const ref = db.collection('matches').doc(mid);
            const g = (await t.get(ref)).data();
            let p2Pos = g.p2Pos; let bestMoveIdx = -1; let bestScore = -100;

            for(let i=0; i<4; i++) {
                const pos = p2Pos[i]; let score = -1;
                if((pos === -1 && roll === 6) || (pos !== -1 && pos + roll <= 56)) {
                    score = 0; let newPos = (pos === -1) ? 0 : pos + roll;
                    let targetCell = pathMap['green'][newPos];
                    if(!safeZone.includes(targetCell) && newPos < 56) {
                        g.p1Pos.forEach(op => { if(op !== -1 && op < 56 && pathMap['blue'][op] === targetCell) score += 100; });
                    }
                    if(pos === -1 && roll === 6) score += 50;
                    if(safeZone.includes(targetCell)) score += 20;
                    if(newPos === 56) score += 30;
                    if(score > bestScore) { bestScore = score; bestMoveIdx = i; }
                }
            }

            let nextTurn = 'green'; 
            if(bestMoveIdx !== -1) {
                soundMove.play().catch(e=>{});
                const currentPos = p2Pos[bestMoveIdx]; let newPos = (currentPos === -1) ? 0 : currentPos + roll;
                p2Pos[bestMoveIdx] = newPos; const myCell = pathMap['green'][newPos];
                
                // Only kill if NOT safe zone
                if(!safeZone.includes(myCell) && newPos < 56) {
                    g.p1Pos.forEach((op, oi) => { if(op !== -1 && op < 56 && pathMap['blue'][op] === myCell) g.p1Pos[oi] = -1; });
                }
                
                if(roll !== 6 && newPos !== 56) nextTurn = 'blue';
            } else { 
                // CRUCIAL FIX: If bot cannot move, PASS turn
                nextTurn = 'blue'; 
            }

            let winner = null; if(p2Pos.every(p => p===56)) winner = 'bot_system_ai';
            
            t.update(ref, { 
                p1Pos: g.p1Pos, 
                p2Pos: p2Pos, 
                diceRolled: false, 
                turn: nextTurn, 
                winner: winner || firebase.firestore.FieldValue.delete() 
            });
        }).then(() => { botProcessing = false; });
    }

    function renderTokens(p1Arr, p2Arr) {
        document.querySelectorAll('.token').forEach(e => e.remove());
        let cellOccupancy = {};
        const createToken = (color, i, pos) => {
            const div = document.createElement('div'); div.className = `token token-${color}`; div.id = `t-${color}-${i}`;
            let parentId = (pos === -1) ? `${color}-jail-${i}` : pathMap[color][pos];
            const p = document.getElementById(parentId);
            if(p) { 
                p.appendChild(div); div.onclick = () => handleTokenClick(color, i, pos);
                if(pos !== -1 && pos !== 56) { if(!cellOccupancy[parentId]) cellOccupancy[parentId] = []; cellOccupancy[parentId].push(div); }
            }
        };
        p1Arr.forEach((p, i) => createToken('blue', i, p)); 
        p2Arr.forEach((p, i) => createToken('green', i, p));

        for (let cellId in cellOccupancy) {
            const tokens = cellOccupancy[cellId];
            if(tokens.length > 1) {
                tokens.forEach((t, index) => {
                    t.classList.add('grouped');
                    if(index < 4) t.classList.add(`stack-${index}`); else t.classList.add('stack-center');
                });
            }
        }
    }

    // --- UTILS ---
    function resizeBoard() {
        const b = document.getElementById('game-area');
        const scale = Math.min(window.innerWidth / 760, window.innerHeight / 760) * 0.95;
        if(b) b.style.transform = `scale(${scale})`;
    }
    window.addEventListener('resize', resizeBoard);
    function showScreen(id) { 
        document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active')); 
        document.getElementById(id).classList.add('active'); 
        if(id==='ludo-game') { document.getElementById('main-wallet-btn').style.display='none'; resizeBoard(); } 
        else if(user) { document.getElementById('main-wallet-btn').style.display='flex'; }
    }
    function backToHome() { if(currentMatch && document.getElementById('ludo-game').classList.contains('active')) { alert("Match Active!"); return; } showScreen('home-screen'); }
    function toggleSidebar() { document.getElementById('wallet-sidebar').classList.toggle('open'); }
    function switchTab(t) { document.getElementById('dep-section').style.display=t==='deposit'?'block':'none'; document.getElementById('with-section').style.display=t==='withdraw'?'block':'none'; }
    function openSettings() { document.getElementById('settings-modal').style.display = 'flex'; }
    function closeSettings() { document.getElementById('settings-modal').style.display = 'none'; }
    function openPassModal() { document.getElementById('settings-modal').style.display='none'; document.getElementById('pass-modal').style.display='flex'; }
    function closePassModal() { document.getElementById('pass-modal').style.display='none'; document.getElementById('settings-modal').style.display='flex'; }
</script>
</body>
</html>
